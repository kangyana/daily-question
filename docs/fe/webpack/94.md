# 【Q094】常见的配置项


::: tip Issue
欢迎在 Gtihub Issue 中回答此问题: [Issue 94](https://github.com/kangyana/daily-question/issues/94)
:::

::: tip Author
回答者: [kangyana](https://github.com/kangyana)
:::
## 1. 模块热替换
### 启用 HMR
启用此功能需要更新 `webpack-dev-server` 的配置，和使用 webpack 内置的 HMR 插件。

**webpack.config.js**
```javascript
module.exports = {
    devServer: {
        hot: true
    }
};
```

**worker.js**
```javascript
if (module.hot) {
  module.hot.accept('./print.js', function() {
    console.log('模块更新');
  })
}
```

### HMR 修改样式表
CSS 的模块热更新，借助于 `style-loader`。

## 2. Tree shaking
### 设置 sideEffects
在 `package.json` 中：
```json
{
  "name": "your-project",
  "sideEffects": [
    "./src/some-side-effectful-file.js",
    "*.css"
  ]
}
```

sideEffects 可选值：

- false ，所有文件代码都没有副作用
- 数组，指定文件代码是有副作用

「副作用」的定义是，在导入时会执行特殊行为的代码，而不是仅仅暴露一个 `export` 或多个 `export`。
举例说明，例如 polyfill，它影响全局作用域，并且通常不提供 `export`。有副作用的不能 `tree sharking`!

**注意**，任何导入的文件都会受到 `tree shaking` 的影响。
这意味着，如果在项目中使用类似 `css-loader` 并导入 CSS 文件，则需要将其添加到 `sideEffect` 列表中，以免在生产模式中无意中将它删除。

还可以在 `module.rules` 配置选项 中设置 `sideEffects`

### 压缩输出
从 v4 开始，也可以通过 `mode` 配置选项轻松切换到压缩输出，只需设置为 `production`。
```javascript
// webpack.config.js

module.exports = {
  mode: "production"
};
```

### tree sharking 条件

- 使用 ES2015 模块语法（即 `import` 和 `export`）
- 在项目 `package.json` 文件中，添加一个 `sideEffects` 入口
- 引入一个能够删除未引用代码(dead code)的压缩工具(minifier)（例如 `UglifyJSPlugin`,  v4 开始可以设置 `mode: "production"`来代替）
::: tip Author
回答者: [kangyana](https://github.com/kangyana)
:::
## 3. devtool
**生产环境**，在使用 `uglifyjs-webpack-plugin` 时，你必须提供 `sourceMap：true` 选项来启用 source map 支持。
**鼓励你在生产环境中启用 source map**，因为它们对调试源码(debug)和运行基准测试(benchmark tests)很有帮助。

### 开发环境

- `eval`：映射到转换后的代码
- `eval-source-map`：行数能够正确映射，会映射到原始代码中。
- `cheap-eval-source-map`：类似 `eval-source-map`，每个模块使用 `eval()` 执行。
这是 **低开销** 的 source map，因为它没有生成列映射，只是映射行数。
它会忽略源自 `loader` 的 source map，并且仅显示转译后的代码，就像 `eval devtool`。
- `cheap-module-eval-source-map` ：类似 `cheap-eval-source-map`。
并且，在这种情况下，源自 `loader` 的 source map 会得到更好的处理结果。
然而，`loader` source map 会被简化为每行一个映射。

### 生产环境

- `none`（省略 devtool 选项）：不生成 source map。这是一个不错的选择。
- `source-map`：整个 source map 作为一个单独的文件生成。
它为 `bundle` 添加了一个引用注释，以便开发工具知道在哪里可以找到它。
**你应该将你的服务器配置为，不允许普通用户访问 source map 文件！**
- `hidden-source-map` ：与 `source-map` 相同，但不会为 `bundle` 添加引用注释。
如果你只想 source map 映射那些源自错误报告的错误堆栈跟踪信息，但不想为浏览器开发工具暴露你的 source map，这个选项会很有用。
**你不应将 source map 文件部署到 web 服务器。而是只将其用于错误报告工具。**
- `nosources-source-map`：创建的 source map 不包含 **源代码内容**。
它可以用来映射客户端上的堆栈跟踪，而无须暴露所有的源代码。
你可以将 source map 文件部署到 web 服务器。
**这仍然会暴露反编译后的文件名和结构，但它不会暴露原始代码。**

### 特定场景
以下选项对于开发环境和生产环境并不理想。
他们是一些特定场景下需要的，例如，针对一些第三方工具。

- `inline-source-map`：source map 转换为 DataUrl 后添加到 `bundle` 中。
- `cheap-source-map`：没有列映射的 source map，忽略 `loader` source map。
- `inline-cheap-source-map`：类似 `cheap-source-map`，但是 source map 转换为 DataUrl 后添加到 `bundle` 中。
- `cheap-module-source-map`：没有列映射的 source map，将 `loader` source map 简化为每行一个映射。
- `inline-cheap-module-source-map`：类似 `cheap-module-source-map`，但是 source map 转换为 DataUrl 添加到 `bundle` 中。

## 4. 指定环境变量
### 基本使用
`NODE_ENV` 属性：

这个变量并不是 `pocess.env` 直接就有的，而是通过设置得到的。
可以通过判断这个变量区分开发环境或生产环境。

我们可以使用 webpack 内置的 `DefinePlugin` 为所有的依赖定义这个变量：
```javascript
// webpack.prod.js

const webpack = require('webpack');
const merge = require('webpack-merge');
const common = require('./webpack.common.js');

module.exports = merge(common, {
  plugins: [
    new webpack.DefinePlugin({
      'process.env.NODE_ENV': JSON.stringify('production')
    })
  ]
});
```

任何位于 `/src` 的本地代码都可以关联到 `process.env.NODE_ENV` 环境变量，所以以下检查也是有效的：
```javascript
// src/worker.js

import { cube } from './math.js';

if (process.env.NODE_ENV !== 'production') {
  console.log('Looks like we are in development mode!');
}
```

### 如何在 webpack 配置文件里获取 NODE_ENV 的值
在 `package.json` 配置 `corss-env`：
```json
"scripts": {
    "build-prod":"cross-env NODE_ENV=production webpack"
}
```

通过 `cross-env NODE_ENV=production`，信息传递给了 webpack 的配置文件, src 文件下面不能访问。
